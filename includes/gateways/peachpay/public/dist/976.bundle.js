"use strict";(self.webpackChunkpeachpay_for_woocommerce=self.webpackChunkpeachpay_for_woocommerce||[]).push([[976],{8756:(a,e,n)=>{n.r(e),n.d(e,{default:()=>k});var t=n(655),o=n(7059),r=n(7629),c=n(7462),s=n(9350),i=n(6673),u=n(9545);function d(){o.h.subscribe((function(){var a,e,n,t,o,s,d,l,p,m,h;a=r.hv.selectedProvider(),e=c.qA.modalUI.loadingMode(),n=i.z9.total(),t=i.z9.subscriptionPresent(),null===(o=(0,u.MW)('.pp-pm-type[data-method="amazon-pay"]'))||void 0===o||o.classList.remove("hide"),"amazonpay"===a&&"finished"===e&&!t&&n>0?(null===(s=(0,u.MW)("#amazon-pay-btn-container"))||void 0===s||s.classList.remove("hide"),null===(d=(0,u.MW)("#amazon-pay-btn-container-existing"))||void 0===d||d.classList.remove("hide"),null===(l=(0,u.MW)("#amazon-pay-btn-container-mobile"))||void 0===l||l.classList.remove("hide")):(null===(p=(0,u.MW)("#amazon-pay-btn-container"))||void 0===p||p.classList.add("hide"),null===(m=(0,u.MW)("#amazon-pay-btn-container-existing"))||void 0===m||m.classList.add("hide"),null===(h=(0,u.MW)("#amazon-pay-btn-container-mobile"))||void 0===h||h.classList.add("hide"))}))}var l=n(3413),p=n(9970),m=n(9213),h=n(6204),y=n(8401);function v(){var a=p.gx.shipping,e=a.firstName,n=a.lastName,o=a.address1,r=a.address2,c=a.city,s=a.state,i=a.postal,u=a.country,d=a.phone,l=0===r().length?{}:{addressLine1:r()};return(0,t.pi)({name:e()+" "+n(),addressLine1:o(),city:c(),stateOrRegion:s(),postalCode:i(),countryCode:u(),phoneNumber:d()},l)}function b(a){switch(a){case"US":return"https://static-na.payments-amazon.com/checkout.js";case"JP":return"https://static-fe.payments-amazon.com/checkout.js";case"GB":case"DK":case"FR":case"DE":case"HU":case"IT":case"LU":case"AW":case"PT":case"ES":case"SE":return"https://static-eu.payments-amazon.com/checkout.js";default:return}}function f(a,e){return(0,t.mG)(this,void 0,void 0,(function(){var n;return(0,t.Jh)(this,(function(t){switch(t.label){case 0:return[4,fetch((0,l.BS)(s.l9.hostName(),c.qA.testMode())+"api/v1/amazonpay/signature",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({session:{id:y.Z5.sessionId(),merchant_id:s.l9.id(),merchant_url:s.l9.hostName(),merchant_name:s.l9.name(),plugin_version:c.qA.plugin.version(),platform:"woocommerce"},transaction:{amazonpay:{payload:a,sandbox:e}}})})];case 1:return(n=t.sent()).ok?[4,n.json()]:[2,""];case 2:return[2,t.sent().signature]}}))}))}function z(a){var e,n,o;return(0,t.mG)(this,void 0,void 0,(function(){var r,u,d,l,p,m,h,y;return(0,t.Jh)(this,(function(b){switch(b.label){case 0:return r=null!==(e=c.L0.metadata("amazonpay_payment_method","public_key_id"))&&void 0!==e?e:"",u=null!==(n=c.L0.metadata("amazonpay_payment_method","store_id"))&&void 0!==n?n:"",d=null!==(o=c.L0.metadata("amazonpay_payment_method","merchant_id"))&&void 0!==o?o:"",l=c.qA.isTestOrDevSite(),p=s.l9.currency.configuration().number_of_decimals,m=i.z9.virtual()?{}:{addressDetails:v()},[4,f(h=(0,t.pi)({webCheckoutDetails:{checkoutResultReturnUrl:a,checkoutMode:"ProcessOrder"},storeId:u,scopes:["name","email","phoneNumber","billingAddress"],paymentDetails:{paymentIntent:"AuthorizeWithCapture",chargeAmount:{amount:i.AQ.total().toFixed(p),currencyCode:s.l9.currency.code()},presentmentCurrency:s.l9.currency.code()}},m),l)];case 1:return y=b.sent(),[2,{publicKeyId:r,storeId:u,merchantId:d,sandbox:l,addressDetails:m,payload:h,signature:y}]}}))}))}function g(a,e){var n,t,o=c.L0.metadata(a,"limits");if(!o)return"n/a";var r=o;if(!r)return"n/a";if(r.default_currency!==s.l9.currency.code())return"n/a";var i=null!==(n=r["pm_".concat(e)])&&void 0!==n?n:"n/a",u=null!==(t=r["merchant_".concat(e)])&&void 0!==t?t:"n/a";return"n/a"!==u?u:i}const _=n.p+"img/f3896d63aa9fcf4e95c0-amazon.svg",w=n.p+"img/2c43108c2527a9ce8f67-amazon-pay-card.svg";var L=n(3176),A=n(3305);function k(a){return(0,t.mG)(this,void 0,void 0,(function(){var e=this;return(0,t.Jh)(this,(function(n){switch(n.label){case 0:return[4,(0,u.ve)("https://static-na.payments-amazon.com/checkout.js","amazon",(function(){!function(){var a,e,n={},s=function(){var a,e;return{config:{name:"Amazon Pay",slug:"amazonpay",gateway:"peachpay_amazonpay",description:"Please click the Amazon Pay button to complete your checkout.",reusable:!1,assets:{title:{src:w},badge:{src:_}},supports:{minimumTotal:g("amazonpay_payment_method","min"),maximumTotal:g("amazonpay_payment_method","max"),currencies:null!==(a=c.L0.metadata("amazonpay_payment_method","supported_currencies"))&&void 0!==a?a:["ALL"],customerCountries:null!==(e=c.L0.metadata("amazonpay_payment_method","supported_countries"))&&void 0!==e?e:["ALL"],productTypes:[],virtualProducts:!0,shippingMethods:[]}}}}();n.amazonpay=s;var i={methods:{}};try{for(var u=(0,t.XA)(Object.entries(n)),d=u.next();!d.done;d=u.next()){var l=(0,t.CR)(d.value,2),p=l[0],m=l[1];i.methods[p]=m.config}}catch(e){a={error:e}}finally{try{d&&!d.done&&(e=u.return)&&e.call(u)}finally{if(a)throw a.error}}o.h.dispatch((0,r.DK)({amazonpay:i}))}(),d();var n="",s=c.qA.modalUI.page();o.h.subscribe((function(){return(0,t.mG)(e,void 0,void 0,(function(){return(0,t.Jh)(this,(function(e){switch(e.label){case 0:return 0===i.AQ.total()?[2]:"amazonpay:amazonpay"===r.hv.selectedPaymentMethod()&&"amazonpay:amazonpay"!==n||"amazonpay:amazonpay"===r.hv.selectedPaymentMethod()&&"payment"===c.qA.modalUI.page()&&"payment"!==s?(n="amazonpay:amazonpay",s="payment",[4,I(a)]):[3,2];case 1:e.sent(),e.label=2;case 2:return r.hv.selectedPaymentMethod()!==n&&(n=r.hv.selectedPaymentMethod()),c.qA.modalUI.page()!==s&&(s=c.qA.modalUI.page()),[2]}}))}))}))}))];case 1:return n.sent(),[2]}}))}))}function I(a){var e,n,o;return(0,t.mG)(this,void 0,void 0,(function(){var r,c=this;return(0,t.Jh)(this,(function(d){switch(d.label){case 0:return(0,u.HD)(".pp-amazon-pay-btn-container",(function(a){var e=a.id,n=a.parentElement;null==n||n.replaceChildren(),null!==n&&(n.innerHTML="");var t='<div id="'.concat(e,'" class=""></div>');null==n||n.insertAdjacentHTML("beforeend",t)})),null===(e=(0,u.MW)("#amazon-pay-btn-container"))||void 0===e||e.classList.add("pp-amazon-pay-btn-container"),null===(n=(0,u.MW)("#amazon-pay-btn-container-mobile"))||void 0===n||n.classList.add("pp-amazon-pay-btn-container"),null===(o=(0,u.MW)("#amazon-pay-btn-container-existing"))||void 0===o||o.classList.add("pp-amazon-pay-btn-container"),[4,z("".concat(A.a.phpData.plugin_asset_url,"public/amazon-checkout.html"))];case 1:return r=d.sent(),["#amazon-pay-btn-container","#amazon-pay-btn-container-mobile","#amazon-pay-btn-container-existing"].forEach((function(e){amazon.Pay.renderButton(e,{merchantId:r.merchantId,publicKeyId:r.publicKeyId,ledgerCurrency:s.l9.currency.code(),checkoutLanguage:"en_US",productType:i.z9.virtual()?"PayOnly":"PayAndShip",placement:"Cart",buttonColor:"Gold",sandbox:r.sandbox}).onClick((function(){return(0,t.mG)(c,void 0,void 0,(function(){var e,n;return(0,t.Jh)(this,(function(t){switch(t.label){case 0:return null===(n=(0,u.MW)("body"))||void 0===n||n.classList.add("pp-disabled"),e="".concat(A.a.phpData.plugin_asset_url,"public/amazon-checkout.html"),[4,C(r,e,a)];case 1:return t.sent(),[2]}}))}))}))})),[2]}}))}))}function C(a,e,n){return(0,t.mG)(this,void 0,void 0,(function(){var r,d,m,h,v,f,z=this;return(0,t.Jh)(this,(function(g){switch(g.label){case 0:return r=s.l9.currency.configuration().number_of_decimals,d=btoa(JSON.stringify({buttonData:{merchantId:a.merchantId,publicKeyId:a.publicKeyId,ledgerCurrency:s.l9.currency.code(),checkoutLanguage:c.qA.language().replace("-","_"),productType:i.z9.virtual()?"PayOnly":"PayAndShip",placement:"Cart",buttonColor:"Gold",sandbox:a.sandbox},initCheckoutData:{createCheckoutSessionConfig:{payloadJSON:JSON.stringify(a.payload),signature:a.signature,publicKeyId:a.publicKeyId}},scriptLink:b(p.gx.billing.country())})),m=function(a,e,n,t,o){if(null!==(null==n?void 0:n.top)){var r=n.top.outerHeight/2+n.top.screenY-o/2,c=n.top.outerWidth/2+n.top.screenX-t/2;return n.open(a,e,"toolbar=no, location=no, directories=no, status=yes, menubar=no, scrollbars=yes, resizable=yes, copyhistory=no, width=".concat(t,", height=").concat(o,", top=").concat(r,", left=").concat(c))}return null}("".concat(e,"?amazon_data=").concat(d),"amazonPayPopup",window,550,515),h=setInterval((function(){var a;(null==m?void 0:m.closed)&&(clearInterval(h),null===(a=(0,u.MW)("body"))||void 0===a||a.classList.remove("pp-disabled"))}),1e3),null===m?[3,3]:[4,n.startTransaction("peachpay_amazonpay","default")];case 1:return v=g.sent(),[4,n.placeOrder(v)];case 2:if(f=g.sent(),!v||"success"!==f.result)return[2];(0,u.JM)("pp-amazon-popup-closed",(function(){var a;null===(a=(0,u.MW)("body"))||void 0===a||a.classList.remove("pp-disabled")})),(0,u.ml)("pp-amazon-checkout-failed",(function(e){o.h.dispatch((0,c.tv)()),window.alert("Amazon Pay was unable to proceed with checkout due to the following:\n".concat(e.message)),(0,L.W4)(new Error(e.message),{amazonpay_session:a})})),(0,u.ml)("pp-amazon-checkout-complete",(function(e){return(0,t.mG)(z,void 0,void 0,(function(){var u,d,p,h;return(0,t.Jh)(this,(function(t){switch(t.label){case 0:return u=e.sessionId,m.postMessage({event:"pp-amazon-received-session-id"},"*"),d={session:{id:y.Z5.sessionId(),merchant_id:s.l9.id(),merchant_url:s.l9.hostName(),merchant_name:s.l9.name(),plugin_version:c.qA.plugin.version(),platform:"woocommerce"},transaction:{amazonpay:{payload:{chargeAmount:{amount:i.AQ.total().toFixed(r),currencyCode:s.l9.currency.code()}},session_id:u,sandbox:a.sandbox}},order:{id:String(f.order_id),amount:i.AQ.total().toFixed(r),currency:s.l9.currency.code(),data:f}},[4,fetch((0,l.BS)(s.l9.hostName(),c.qA.testMode())+"api/v1/amazonpay/checkout",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(d)})];case 1:return(p=t.sent()).ok?[4,p.json()]:((0,L.W4)(new Error("Call to PeachPay API /amazonpay/checkout failed"),{amazonpay_session:a,request:d,response:p}),[2]);case 2:return h=t.sent(),o.h.dispatch((0,c.N5)()),[4,M(h,u,n,v,f)];case 3:return t.sent(),[2]}}))}))})),g.label=3;case 3:return[2]}}))}))}function M(a,e,n,r,s){return(0,t.mG)(this,void 0,void 0,(function(){return(0,t.Jh)(this,(function(t){switch(t.label){case 0:return"Completed"===a.data.statusDetails.state?[3,1]:(o.h.dispatch((0,c.tv)()),[3,4]);case 1:return[4,n.setOrderStatus(s,r,{amazonpay:{session_id:e},paymentStatus:"success",orderStatus:"success"})];case 2:return t.sent(),o.h.dispatch((0,p.ud)({provider:"amazonpay",method:"amazonpay"})),[4,(0,m.ll)()];case 3:t.sent(),(0,h.c)(),window.top&&(window.top.location=s.redirect),t.label=4;case 4:return[2]}}))}))}}}]);